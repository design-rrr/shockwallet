import { SetStateAction, useCallback, useEffect, useMemo, useState } from "react";
import * as Types from "../../../Api/pub/autogenerated/ts/types";
import { getNostrClient, parseNprofile } from "../../../Api/nostr";
import { useDispatch, useSelector } from "../../../State/store";
import { Modal } from "../Modal";
import { decodeInvoice, NOSTR_RELAYS } from "../../../constants";
import { nip19 } from "nostr-tools";
import styles from "./styles/index.module.scss";
import { BackCircleIcon, BanIcon, CrossIcon, ShieldIcon, TrashIcon } from '../../../Assets/SvgIconLibrary';
import Dropdown from "../../Dropdowns/LVDropdown";
import Checkbox from "../../Checkbox";
import classNames from "classnames";
import { refetchDebits, refetchManageRequests, removeDebitRequest, removeManageRequest, setDebitToEdit } from "../../../State/Slices/modalsSlice";
import { toast } from "react-toastify";
import Toast from "../../Toast";
import { getDebitAppNameAndAvatarUrl } from "../DebitRequestModal/helpers";

export const ManageRequestModal = () => {
	const price = useSelector((state) => state.usdToBTC);
	const spendSources = useSelector(state => state.spendSource);
	const dispatch = useDispatch();

	const manageRequests = useSelector(state => state.modalsSlice.manageRequests || null)

	// Display requestor name and avatar
	const [requestorDomain, setRequestorDomain] = useState("");
	const [requestorAvatarUrl, setRequestorAvatarUrl] = useState("");

	const [isBanPrompt, setIsBanPrompt] = useState(false);




	const currentRequest = useMemo(() => {
		console.log("manageRequests", manageRequests)
		setIsBanPrompt(false);
		if (!manageRequests) return null;
		if (manageRequests.length > 0) {
			const req = manageRequests[0]; // take first request in the array; new requests are pushed to the end of the array. FIFO

			if (!spendSources.sources[req.sourceId]) return null; // If the spend source was deleted ignore the request
			return { request: req.request, source: spendSources.sources[req.sourceId] }
		}
	}, [manageRequests, spendSources])



	// when a request is received try to fetch a nip05 for the requestor pubkey and get the domain.
	// the domain will be used to supplement the data dispayed in the debit request modal, such as domain name and avatar
	useEffect(() => {
		const getAppNameAndAvatar = async () => {
			if (!currentRequest) return;

			// TODO: Have the request include a relay to fetch metadata from.
			// For now the code just uses the relay of the source receiving the nip68 request.
			// Note: SMART is supposed to handle this later
			const { requestorDomain: rd, avatarUrl } = await getDebitAppNameAndAvatarUrl(currentRequest.request.npub, parseNprofile(currentRequest.source.pasteField).relays || NOSTR_RELAYS)
			setRequestorDomain(rd)
			setRequestorAvatarUrl(avatarUrl)
		};

		getAppNameAndAvatar();

	}, [currentRequest])


	const authroizeRequest = useCallback(async () => {
		if (!currentRequest) return;

		const res = await (await getNostrClient(currentRequest.source.pasteField, currentRequest.source.keys)).AuthorizeManage({
			authorize_npub: currentRequest.request.npub,
			request_id: currentRequest.request.request_id,
			ban: false,
		});
		if (res.status !== "OK") {
			toast.error(<Toast title="Add linked app error" message={res.reason} />)
			return;
		}
		dispatch(removeManageRequest({ requestorNpub: currentRequest.request.npub, sourceId: currentRequest.source.id }))
		dispatch(refetchManageRequests())
		toast.success("Linked app added successfuly")
	}, [dispatch, currentRequest]);





	const substrinedNpub = useMemo(() => {
		if (!currentRequest) return "";
		const npub = nip19.npubEncode(currentRequest.request.npub);
		return `${npub.substring(0, 20)}...${npub.substring(npub.length - 20, npub.length)}`
	}, [currentRequest])


	const banRequest = useCallback(async () => {
		if (currentRequest) {
			await (await getNostrClient(currentRequest.source.pasteField, currentRequest.source.keys)).AuthorizeManage({
				authorize_npub: currentRequest.request.npub,
				request_id: currentRequest.request.request_id,
				ban: true
			});
			dispatch(removeManageRequest({ requestorNpub: currentRequest.request.npub, sourceId: currentRequest.source.id }));
		}
	}, [currentRequest, dispatch])

	const modalContent = currentRequest ? (
		<div className={styles["container"]}>
			<div className={styles["modal-header"]}>Incoming Request</div>
			<div className={styles["modal-body"]}>
				<div className={styles["requestor-container"]}>
					{
						requestorAvatarUrl
						&&
						<img src={requestorAvatarUrl} alt="Requestor avatar" height={55} width={55} />
					}
					{
						requestorDomain
						&&
						<span className={styles["app-name"]}>{requestorDomain}</span>
					}
					<span className={styles["npub"]}>{substrinedNpub}</span>
				</div>

				<>
					{
						isBanPrompt
							?
							<PromptBanApp banAppCallback={banRequest} dismissCallback={() => banRequest()} />
							:
							<>
								<div className={styles["debit-info"]}>
									<span className={styles["orange-text"]}>Wants to create offers for you</span>
								</div>
								<div className={styles["buttons-container"]}>
									<button onClick={() => banRequest()}>
										<>
											<CrossIcon />
											Deny
										</>
									</button>
									<button onClick={() => authroizeRequest()}>
										<>
											<ShieldIcon />
											Allow
										</>
									</button>
								</div>
							</>
					}
				</>
			</div>

		</div>
	) : <></>;



	return <Modal isShown={!!currentRequest} hide={() => banRequest()} modalContent={modalContent} headerText={''} />
}

interface PromptBanAppProps {
	banAppCallback: () => Promise<void>;
	dismissCallback: () => void;
}

const PromptBanApp = ({ banAppCallback, dismissCallback }: PromptBanAppProps) => {
	return (
		<>
			<div className={classNames(styles["debit-info"], styles["ban-prompt-body"])}>
				<span>Ban this key?</span>
			</div>
			<div className={styles["buttons-container"]}>
				<button onClick={banAppCallback}>
					<>
						<BanIcon />
						BAN
					</>
				</button>
				<button onClick={dismissCallback}>
					<>
						<BackCircleIcon />
						DISMISS
					</>
				</button>
			</div>
		</>
	)
}