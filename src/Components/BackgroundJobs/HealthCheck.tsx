import { useEffect } from "react"
import { useDispatch, useSelector } from "../../State/store"
import { Subscription, SubscriptionPayment, addSubPayment, removeActiveSub } from "../../State/Slices/subscriptionsSlice"
import { InputClassification, openNotification, usdToBTCSpotLink } from "../../constants"
import { createLnurlInvoice, handlePayInvoice } from "../../Api/helpers"
import axios from "axios"
import { disconnectNostrClientCalls, getNostrClient, parseNprofile } from "../../Api/nostr"
import { setLatestOperation } from "../../State/Slices/HistorySlice"
import { UserOperationType } from "../../Api/autogenerated/ts/types"
import { editPaySources } from "../../State/Slices/paySourcesSlice"
import { editSpendSources } from "../../State/Slices/spendSourcesSlice"
const SubsCheckIntervalSeconds = 10 * 60
export const HealthCheck = () => {
    const paySource = useSelector(({ paySource }) => paySource)
    const spendSource = useSelector(({ spendSource }) => spendSource)
    const dispatch = useDispatch();

    useEffect(() => {
        const interval = setInterval(() => {
            checkHealth()
        }, SubsCheckIntervalSeconds * 1000)
        checkHealth()
        return () => {
            clearInterval(interval)
        }
    }, [])

    const checkHealth = async () => {
        const sourcesToCheckMap: Record<string, boolean> = {}
        const checkFunc = (s: { pasteField: string }) => {
            if (s.pasteField.startsWith("nprofile")) {
                sourcesToCheckMap[s.pasteField] = true
            }
        }
        paySource.forEach(checkFunc)
        spendSource.forEach(checkFunc)
        const sourcesToCheck = Object.keys(sourcesToCheckMap)
        await Promise.all(sourcesToCheck.map(async s => {
            const c = await getNostrClient(s)
            const healthPromise = c.UserHealth()
            const timeout = setTimeout(() => {
                disconnectNostrClientCalls(s)
                updateSubState(s, false)
            }, 30 * 1000);
            await healthPromise
            clearTimeout(timeout)
            updateSubState(s, true)
        }))
    }

    const updateSubState = (source: string, connected: boolean) => {
        const payEntry = paySource.find(s => s.pasteField === source)
        if (payEntry) {
            dispatch(editPaySources({ ...payEntry, disconnected: !connected }))
        }
        const spendEntry = spendSource.find(s => s.pasteField === source)
        if (spendEntry) {
            dispatch(editSpendSources({ ...spendEntry, disconnected: !connected }))
        }
    }

    return null
}