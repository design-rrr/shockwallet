import { lightningIcon, linkIcon } from "../../Assets/SvgIconLibrary";
import * as Types from "../../Api/autogenerated/ts/types";
import * as Icons from "../../Assets/SvgIconLibrary";
import { useMemo, useState } from "react";
import { useSelector } from "../../State/store";
import { getIdentifierLink } from "../../State/Slices/addressbookSlice";
import { decode } from "@gandlaf21/bolt11-decode";
import moment from 'moment';
import { AnimatePresence, motion } from "framer-motion";
import { TransactionInfo } from "../../Pages/Home";
import TransactionInfoModal from "../TransactionInfoModal";


const stateIcons = (icon?: string) => {
  switch (icon) {
    case 'lightning':
      return lightningIcon();
  
    case 'linked':
      return linkIcon();
  }
}
interface Props {
  operation:  TransactionInfo;
  underline: boolean;

}

export const SwItem = ({
  operation,
  underline,
}: Props): JSX.Element => {
  const addressbook = useSelector(({ addressbook }) => addressbook);
  const price = useSelector((state) => state.usdToBTC);

  underline = underline ?? true;

  const [shown, setShown] = useState(false);


  const transactionObject = useMemo(() => {
    let label = getIdentifierLink(addressbook, operation.identifier);
    if (label === operation.identifier && operation.type === Types.UserOperationType.INCOMING_INVOICE) {
      const decodedInvoice = decode(operation.identifier);
      const description = decodedInvoice.sections.find(section => section.name === "description");
      if (description) {
        label = description.value;
      }
    }
    return {
      priceImg: operation.inbound ? Icons.PriceUp : Icons.PriceDown,
      station: label.length < 30 ? label : `${label.substring(0, 9)}...${label.substring(label.length - 9, label.length)}`,
      changes: `${operation.inbound ? "" : "-"}${operation.amount}`,
      date: !operation.confirmed ? "Pending" : moment(operation.paidAtUnix * 1000).fromNow(),
      price: Math.round(100 * operation.amount * price.sellPrice / (100 * 1000 * 1000)) / 100,
      stateIcon: !operation.confirmed ? "linked" : "lightning",
    }
  }, [operation, addressbook, price]);
  
  return(
    <>
      <motion.div className="SwItem" onClick={() => setShown(true)} layoutId={operation.operationId}>
        <div className="SwItem_left">
          {stateIcons(transactionObject.stateIcon)}
          <div className="SwItem_text">
            <div className="SwItem_date">{transactionObject.date}</div>
            <div className="SwItem_station">{transactionObject.station}</div>
          </div>
        </div>
        <div className="SwItem_right">
          <div className="SwItem_price">
            <div className="SwItem_price_img">{transactionObject.priceImg()}</div>
            <div className="SwItem_price_text">{transactionObject.changes}</div>
          </div>
          <div className="SwItem_changes">~ ${transactionObject.price}</div>
        </div>
      </motion.div>
      <div className={underline?"SwItem_divider" : ""}></div>
      <AnimatePresence>
        {
          shown
          &&
          <TransactionInfoModal operation={operation} hide={() => setShown(false)} price={price} />
        }
      </AnimatePresence>
    </>
  )
}