import { PayloadAction, createSlice } from '@reduxjs/toolkit';
import * as Types from '../../Api/autogenerated/ts/types'
type SourceOperations = Record<string /*nprofile*/, Types.UserOperation[]>
type Cursor = Partial<Types.GetUserOperationsRequest>
interface History {
  operations?: SourceOperations
  cursor?: Cursor
  latestOperation?: Partial<Types.UserOperation>
  operationsUpdateHook?: number
};

const historyLocal = localStorage.getItem("history");

const update = (value: History) => {
  const save = JSON.stringify(value)
  localStorage.setItem("history", save);
}

const initialState: History = JSON.parse(historyLocal ?? "{}");
// const ops: SourceOperations = {}
// Object.entries(initialState.operations || {}).forEach(([k, o]) => {
//   if (!Array.isArray(o)) {
//     ops[k] = Object.values(o) || []
//   }
// })
// initialState.operations = ops

const historySlice = createSlice({
  name: 'history',
  initialState,
  reducers: {
    setSourceHistory: (state, action: PayloadAction<{ pub: string, operations: Types.UserOperation[], cursor: Cursor }>) => {
      const { pub, operations, cursor } = action.payload
      if (!state.operations) {
        state.operations = {}
      }
      state.operations[pub] = operations
      state.cursor = { ...cursor }
      state.operationsUpdateHook = Math.random()
      update(state)
    },
    setLatestOperation: (state, action: PayloadAction<{ pub: string, operation: Types.UserOperation }>) => {
      const { pub, operation } = action.payload
      state.latestOperation = { ...operation }
      if (!state.operations) {
        state.operations = {}
      }
      if (!state.operations[pub]) {
        state.operations[pub] = [operation]
      } else if (!state.operations[pub].find(o => o.operationId === operation.operationId)) {
        state.operations[pub].push(operation)
      }
      state.operationsUpdateHook = Math.random()
      update(state)
    },
  },
});

export const { setSourceHistory, setLatestOperation } = historySlice.actions;
export default historySlice.reducer;
