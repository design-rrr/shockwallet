import { toast } from "react-toastify";
import * as Icons from "../../Assets/SvgIconLibrary";
import { Clipboard } from "@capacitor/clipboard";
import { useEffect, useState } from "react";
import { getNostrClient } from "@/Api/nostr";
import * as Types from '../../Api/pub/autogenerated/ts/types'
import { IonIcon, useIonRouter } from "@ionic/react";
import { trashOutline } from "ionicons/icons";
import { useAppSelector } from "@/State/store/hooks";
import { NprofileView, selectHealthyNprofileViews } from "@/State/scoped/backups/sources/selectors";
type OfferItemType = {
	title: string;
	value: string;
	type: string;
};

const Management = () => {
	const router = useIonRouter();
	const healthyNprofileSourceViews = useAppSelector(selectHealthyNprofileViews);


	const [isEdit, setIsEdit] = useState<boolean>(false);

	const [showDropDown, setShowDropDown] = useState<boolean>(false);
	const [allValue, setAllValue] = useState<NprofileView[]>(healthyNprofileSourceViews);

	const [display, setDisplay] = useState(0);
	const [rotation, setRotation] = useState(0);
	const [value, setValue] = useState(healthyNprofileSourceViews[0]);
	const [remainValues, setRemailValues] = useState<NprofileView[]>([]);

	const [displayData, setDisplayData] = useState<NprofileView>();
	const [offerValue, setOfferValue] = useState<string>("");
	const [manageAuths, setManageAuths] = useState<Types.ManageAuthorization[]>([]);
	const [nmanage, setNmanage] = useState<string>("");

	useEffect(() => {
		setShowDropDown(showDropDown);
	}, [showDropDown]);

	const fetchManageAuths = async () => {
		const client = await getNostrClient({ pubkey: value.lpk, relays: value.relays }, value.keys)
		const res = await client.GetManageAuthorizations()
		if (res.status === "OK") {
			setManageAuths(res.manages)
		} else {
			toast.error(res.reason)
		}
	}

	const fetchUserInfo = async () => {
		const client = await getNostrClient({ pubkey: value.lpk, relays: value.relays }, value.keys)
		const res = await client.GetUserInfo()
		if (res.status === "OK") {
			setNmanage(res.nmanage)
		} else {
			toast.error(res.reason)
		}
	}

	useEffect(() => {
		setDisplayData(value)
		fetchManageAuths()
		fetchUserInfo()
	}, [value]);

	const dropdown = () => {
		const remainValues = allValue.filter((e) => e.label !== value.label);
		setRemailValues(remainValues);
		setDisplay(display === 0 ? 1 : 0);
		setRotation(rotation === 0 ? 90 : 0);
	};



	const selectOption = (id: NprofileView) => {
		dropdown();
		setValue(id);
	};

	const CopyToClipboard = async (copyText: string) => {
		let clipbaordStr = "";
		clipbaordStr = copyText;
		await Clipboard.write({
			string: clipbaordStr,
		});
		toast.success("Copied to clipboard");
	};

	const removeManageAuth = async (npub: string) => {
		console.log("removing manage auth", npub)
		const client = await getNostrClient({ pubkey: value.lpk, relays: value.relays }, value.keys)
		const res = await client.ResetManage({ npub })
		if (res.status === "OK") {
			fetchManageAuths()
		} else {
			toast.error(res.reason)
		}
	}

	return (
		<div className="Offers_container">
			<div className="Offers">
				<div className="Offers_header_text">Manage Authorizations</div>
				<div className="Offers_item" onClick={dropdown}>
					<div className="selected_item">
						{value ? (
							<div className="item" key={value.label}>

								<div className="Offers_from_value">{value.label}</div>
							</div>
						) : (
							<div></div>
						)}
						<div
							className="offers_dropdown"
							style={{
								opacity: display,
								transition: "0.3s",
								overflow: "hidden",
							}}
						>
							{display === 1 &&
								remainValues.map((item: NprofileView) => {
									return (
										<div
											onClick={() => {
												selectOption(item);
											}}
											className="item"
											key={item.label}
										>

											<div className="Offers_from_value">{item.label}</div>
										</div>
									);
								})}
						</div>
					</div>
					<div
						className="RightIcon"
						style={{
							transform: `rotate(${rotation}deg)`,
							transition: "0.3s",
						}}
					>
						{Icons.arrow()}
					</div>
				</div>
				<p style={{ fontSize: "12px", color: "gray" }}> {nmanage} </p>
				{manageAuths.map(((o, i) => <div key={i} className="Offers_source">
					<div className="source_header">
						<div className="title">{o.npub}</div>
						<IonIcon icon={trashOutline} onClick={() => removeManageAuth(o.npub)} />
					</div>
					<div className="source_data">is {o.authorized ? "authorized" : "not authorized"}</div>
				</div>))}
			</div>
		</div>
	);
};

export default Management;
