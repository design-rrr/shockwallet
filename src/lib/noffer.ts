import { NostrKeyPair } from '@/Api/nostrHandler';
import { decodeBech32, NofferError, NofferSuccess, OfferPointer, OfferPriceType } from '@shocknet/clink-sdk';
import { Satoshi } from './types/units';
import { getNostrClient, sendNip69 } from '@/Api/nostr';
import type { OfferConfig, OfferInvoice } from '@/Api/pub/autogenerated/ts/types';


export function decodeNoffer(data: string) {
	const decoded = decodeBech32(data);
	if (decoded.type !== "noffer") {
		throw new Error("Invalid noffer");
	}
	return decoded.data;
}


export async function createNofferInvoice(noffer: OfferPointer, keys: NostrKeyPair, amount?: Satoshi): Promise<string | NofferError> {
	const { offer } = noffer
	const res = await sendNip69(noffer, { offer, amount_sats:amount }, keys)
	const resErr = res as NofferError
	if (resErr.error) {
		// If the error is a 5 (range error), we want that error returned to use the reported range
		if (resErr.code === 5) {
			return resErr;
		}
		// If it's any other error, throw it
		throw new Error(resErr.error);
	}
	const bolt11 = (res as NofferSuccess).bolt11
	return bolt11;
}

export function priceTypeToString(priceType: OfferPriceType) {
	switch (priceType) {
		case OfferPriceType.Fixed:
			return "Fixed";
		case OfferPriceType.Variable:
			return "Variable";
		case OfferPriceType.Spontaneous:
			return "Spontaneous";
		default:
			throw new Error("Unknown noffer price type");
	}
}


export async function getUserOffer(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair, offerId: string): Promise<OfferConfig> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.GetUserOffer({ offer_id: offerId });
	if (res.status !== "OK") {
		throw new Error("Failed to fetch offer: " + res.reason);
	}

	return res;
}

export async function getUserOffers(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair): Promise<OfferConfig[]> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.GetUserOffers();
	if (res.status !== "OK") {
		throw new Error("Failed to fetch offers: " + res.reason);
	}

	return res.offers;
}

export async function addUserOffer(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair, offer: OfferConfig): Promise<string> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.AddUserOffer(offer);
	if (res.status !== "OK") {
		throw new Error("Failed to add offer: " + res.reason);
	}

	return res.offer_id;
}


export async function updateUserOffer(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair, offer: OfferConfig): Promise<void> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.UpdateUserOffer(offer);
	if (res.status !== "OK") {
		throw new Error("Failed to add offer: " + res.reason);
	}
}

export async function getUserOfferInvoices(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair, offerId: string): Promise<OfferInvoice[]> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.GetUserOfferInvoices({ offer_id: offerId, include_unpaid: true });
	if (res.status !== "OK") {
		throw new Error("Failed to get offer invoices: " + res.reason);
	}
	return res.invoices;
}

export async function deleteUserOffer(pastefield: { pubkey: string, relays?: string[] } | string, keys: NostrKeyPair, offerId: string): Promise<void> {
	const client = await getNostrClient(pastefield, keys);
	const res = await client.DeleteUserOffer({ offer_id: offerId });
	if (res.status !== "OK") {
		throw new Error("Failed to delete user Offer: " + res.reason);
	}
}
